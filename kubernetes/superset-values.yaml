# Superset Helm Chart Values
# Configured for External Postgres and Hive Support

# 1. Disable bundled Postgres (we use the shared one)
postgresql:
  enabled: false

# 2. Configure External Database Connection
supersetNode:
  connections:
    db_host: postgres
    db_port: "5432"
    db_user: superset
    db_pass: superset
    db_name: superset
  # Force a secret key (required)
  # Generate a random one in production: openssl rand -base64 42
  secret_key: "superset_secret_key_change_me_in_prod"

# 3. Install Hive Drivers
# These are installed at runtime in the container
extraPyPIPackages:
  - pyhive
  - thrift
  - sasl
  - thrift_sasl
  - psycopg2-binary

# Redis Image Fix (Official Image + Bitnami Chart Overrides)
redis:
  image:
    registry: docker.io
    repository: library/redis
    tag: 7.2
  master:
    command: ["redis-server"]
    args: ["--protected-mode", "no"]
    livenessProbe:
      enabled: true
      exec:
        command: ["redis-cli", "ping"]
    readinessProbe:
      enabled: true
      exec:
        command: ["redis-cli", "ping"]

# 4. Expose Service
service:
  type: ClusterIP

# 5. Ingress Configuration (Traefik)
ingress:
  enabled: true
  ingressClassName: traefik
  hosts:
    - superset.44.220.60.20.sslip.io
  path: /
  pathType: Prefix

# 6. Initialization
# Ensure DB migrations run
bootstrapScript: |
  #!/bin/bash
  # Install build dependencies for SASL
  apt-get update && apt-get install -y gcc g++ libsasl2-dev
  
  # Install Python dependencies
  /app/.venv/bin/python -m ensurepip
  /app/.venv/bin/python -m pip install psycopg2-binary
  /app/.venv/bin/python -m pip install pyhive thrift sasl thrift_sasl
  
  if [ ! -f ~/bootstrap ]; then echo "Running Superset with uid {{ .Values.runAsUser }}" > ~/bootstrap; fi
init:
  enabled: true
  loadExamples: true # Load sample data for the user
  createAdmin: true
  command:
    - "/bin/sh"
    - "-c"
    - "/app/.venv/bin/python -m ensurepip && /app/.venv/bin/python -m pip install psycopg2-binary && (/app/.venv/bin/python -m pip install pyhive thrift pure-sasl || true) && . /app/pythonpath/superset_bootstrap.sh; . /app/pythonpath/superset_init.sh"
  adminUser:
    username: admin
    firstname: Superset
    lastname: Admin
    email: admin@superset.com
    password: admin

# 7. Config Overrides
configOverrides:
  enable_hive: |
    # Force Secret Key
    SECRET_KEY = "superset_secret_key_change_me_in_prod_12345"

    # Enable Hive
    from flask_appbuilder.security.manager import AUTH_DB
    AUTH_TYPE = AUTH_DB
    
    # Allow Hive Uploads
    CSV_EXTENSIONS = {"csv", "tsv", "txt"}
    
    # Feature Flags
    FEATURE_FLAGS = {
        "ENABLE_TEMPLATE_PROCESSING": True,
    }
